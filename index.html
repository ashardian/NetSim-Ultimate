<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RouterOS Advanced | Real-Time Network Simulator</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- THEME VARIABLES --- */
        :root {
            --header-bg: #0f4c81;
            --sidebar-bg: #f8f9fa;
            --active-item: #eef2f6;
            --text-main: #1f2937;
            --border-color: #e5e7eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --muted: #6b7280;
        }

        body { margin: 0; font-family: 'Inter', 'Segoe UI', sans-serif; background: #f3f4f6; color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; color: white; display: inline-block; }
        .badge-success { background: var(--success); }
        .badge-danger { background: var(--danger); }
        .badge-warn { background: var(--warning); color: #fff; }
        
        /* --- LOGIN --- */
        #login-overlay {
            position: fixed; inset: 0; background: rgba(17, 24, 39, 0.8); z-index: 9999;
            display: flex; justify-content: center; align-items: center; backdrop-filter: blur(4px);
        }
        .login-box {
            background: white; padding: 40px; width: 380px; border-radius: 12px; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-top: 6px solid var(--header-bg);
        }

        /* --- LAYOUT --- */
        #app-container { display: flex; flex: 1; height: 100%; transition: opacity 0.4s ease; opacity: 0; }
        
        .sidebar { width: 260px; background: white; border-right: 1px solid var(--border-color); display: flex; flex-direction: column; z-index: 20; }
        .logo-area { background: var(--header-bg); color: white; padding: 24px; font-size: 20px; font-weight: 700; display: flex; align-items: center; gap: 12px; letter-spacing: -0.5px; }
        
        .nav-menu { list-style: none; padding: 15px 0; margin: 0; overflow-y: auto; }
        .nav-item { padding: 14px 24px; cursor: pointer; color: var(--muted); display: flex; align-items: center; gap: 14px; font-size: 14px; transition: all 0.2s; border-left: 4px solid transparent; }
        .nav-item:hover { background: var(--sidebar-bg); color: var(--text-main); }
        .nav-item.active { background: var(--active-item); color: var(--header-bg); border-left-color: var(--header-bg); font-weight: 600; }

        .main-content { flex: 1; display: flex; flex-direction: column; min-width: 0; background: #f9fafb; }
        .top-bar { background: white; padding: 0 30px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; height: 64px; }
        
        .workspace { padding: 30px; overflow-y: auto; flex: 1; position: relative; scroll-behavior: smooth; }

        /* --- UI COMPONENTS --- */
        .panel { background: white; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 25px; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .panel-head { background: #f9fafb; padding: 16px 24px; border-bottom: 1px solid var(--border-color); font-weight: 600; color: #374151; display: flex; justify-content: space-between; align-items: center; border-radius: 8px 8px 0 0; }
        .panel-body { padding: 24px; }

        .form-grid { display: grid; grid-template-columns: 180px 1fr; gap: 20px; align-items: center; margin-bottom: 18px; }
        .form-control { width: 100%; max-width: 350px; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; transition: border-color 0.2s; }
        .form-control:focus { outline: none; border-color: var(--header-bg); box-shadow: 0 0 0 3px rgba(15, 76, 129, 0.1); }

        .btn { background: var(--header-bg); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 500; font-size: 14px; transition: 0.2s; display: inline-flex; align-items: center; gap: 8px; justify-content: center; }
        .btn:hover { background: #0b3d69; transform: translateY(-1px); }
        .btn:active { transform: translateY(0); }
        .btn-sm { padding: 6px 12px; font-size: 12px; }
        .btn-danger { background: var(--danger); }
        .btn-danger:hover { background: #dc2626; }
        .btn-success { background: var(--success); }
        .btn-outline { background: white; border: 1px solid #d1d5db; color: #374151; }
        .btn-outline:hover { background: #f3f4f6; }

        /* --- TABLES --- */
        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; margin-top: 10px; border: 1px solid var(--border-color); border-radius: 6px; overflow: hidden; }
        th { background: #f9fafb; text-align: left; padding: 14px; border-bottom: 1px solid var(--border-color); color: #6b7280; font-weight: 600; }
        td { padding: 14px; border-bottom: 1px solid var(--border-color); color: #374151; background: white; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background: #f9fafb; }

        /* --- VISUALIZER (FIXED BOTTOM) --- */
        .visualizer-container { height: 260px; background: #111827; border-top: 1px solid #374151; display: grid; grid-template-columns: 1fr 420px; color: white; }
        #net-canvas { width: 100%; height: 100%; display: block; cursor: crosshair; }
        
        .controls-overlay { position: absolute; bottom: 20px; left: 20px; display: flex; gap: 10px; z-index: 10; pointer-events: none; }
        .controls-overlay button { pointer-events: auto; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        
        .log-panel { background: #1f2937; border-left: 1px solid #374151; padding: 15px; font-family: 'Menlo', 'Monaco', 'Courier New', monospace; font-size: 11px; overflow-y: auto; display: flex; flex-direction: column; scroll-behavior: smooth; }
        .log-line { padding: 4px 0; border-bottom: 1px solid #374151; line-height: 1.4; }
        .log-allow { color: var(--success); }
        .log-block { color: var(--danger); }
        .log-warn { color: var(--warning); }
        .log-info { color: #9ca3af; }

        /* --- HACKER TIPS --- */
        .hacker-tip-box { background: #fff1f2; border: 1px solid #fecdd3; padding: 16px; border-radius: 8px; margin-bottom: 20px; color: #be123c; font-size: 13px; display: none; line-height: 1.5; }
        .hacker-tip-box.visible { display: block; animation: fadeIn 0.4s; }
        .hacker-tip-box ul { margin: 8px 0 0 20px; padding: 0; }

        /* --- TOAST & REBOOT --- */
        #toast-box { position: fixed; bottom: 280px; right: 20px; z-index: 2000; display: flex; flex-direction: column; gap: 12px; pointer-events: none; }
        .toast { background: #1f2937; color: white; padding: 14px 20px; border-radius: 8px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); display: flex; align-items: center; gap: 12px; animation: slideIn 0.3s; pointer-events: auto; font-size: 14px; }
        
        #reboot-screen { position: fixed; inset: 0; background: rgba(255,255,255,0.98); z-index: 10000; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .progress-track { width: 320px; height: 6px; background: #e5e7eb; border-radius: 10px; overflow: hidden; margin-top: 25px; }
        .progress-fill { height: 100%; background: var(--header-bg); width: 0%; transition: width 0.1s linear; }

        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="reboot-screen">
        <h2 style="color:var(--header-bg); margin-bottom: 5px;">System Restarting</h2>
        <p style="color:#666;">Applying network configuration...</p>
        <div class="progress-track"><div class="progress-fill" id="reboot-bar"></div></div>
        <div id="reboot-txt" style="margin-top:15px; font-weight:bold; color:var(--header-bg); font-family:monospace;">0%</div>
    </div>

    <div id="toast-box"></div>

    <div id="login-overlay">
        <div class="login-box">
            <div style="text-align:center; margin-bottom:30px; color:var(--header-bg);">
                <i class="fa-solid fa-server fa-3x"></i>
                <h2 style="margin:15px 0 5px 0;">RouterOS Ultimate</h2>
                <span style="font-size:12px; color:#6b7280;">Secure Network Administrator</span>
            </div>
            <div style="margin-bottom:20px;">
                <label style="display:block; font-size:12px; font-weight:700; margin-bottom:6px; color:#374151;">USERNAME</label>
                <input type="text" id="user-in" class="form-control" value="admin" style="max-width:100%; box-sizing:border-box;">
            </div>
            <div style="margin-bottom:30px;">
                <label style="display:block; font-size:12px; font-weight:700; margin-bottom:6px; color:#374151;">PASSWORD</label>
                <input type="password" id="pass-in" class="form-control" placeholder="admin" style="max-width:100%; box-sizing:border-box;">
            </div>
            <button class="btn" style="width:100%;" onclick="APP.login()">Access Dashboard</button>
        </div>
    </div>

    <div id="app-container">
        <div class="sidebar">
            <div class="logo-area"><i class="fa-solid fa-wifi"></i> RouterOS</div>
            <ul class="nav-menu">
                <li class="nav-item active" onclick="APP.nav('status', this)"><i class="fa-solid fa-gauge-high"></i> Status</li>
                <li class="nav-item" onclick="APP.nav('wan', this)"><i class="fa-solid fa-globe"></i> Network (WAN)</li>
                <li class="nav-item" onclick="APP.nav('lan', this)"><i class="fa-solid fa-network-wired"></i> LAN Settings</li>
                <li class="nav-item" onclick="APP.nav('wireless', this)"><i class="fa-solid fa-signal"></i> Wireless</li>
                <li class="nav-item" onclick="APP.nav('nat', this)"><i class="fa-solid fa-share-nodes"></i> NAT Forwarding</li>
                <li class="nav-item" onclick="APP.nav('security', this)"><i class="fa-solid fa-shield-halved"></i> Security</li>
                <li class="nav-item" onclick="APP.nav('system', this)"><i class="fa-solid fa-gears"></i> System Tools</li>
            </ul>
        </div>

        <div class="main-content">
            <div class="top-bar">
                <div id="page-crumb" style="font-weight:600; color:#4b5563;">Home > Status</div>
                <div style="display:flex; gap:20px; align-items:center; font-size:13px;">
                    <span style="color:#6b7280; font-family:monospace;"><i class="fa-regular fa-clock"></i> <span id="uptime">00:00:00</span></span>
                    <div style="height:20px; width:1px; background:#e5e7eb;"></div>
                    <button class="btn btn-outline btn-sm" onclick="location.reload()">Logout <i class="fa-solid fa-right-from-bracket"></i></button>
                </div>
            </div>

            <div class="workspace" id="main-view"></div>

            <div class="visualizer-container">
                <div style="position:relative; background:#000;">
                    <canvas id="net-canvas"></canvas>
                    <div class="controls-overlay">
                        <button class="btn btn-success btn-sm" onclick="SIM.spawnPacket(80)">Test HTTP (80)</button>
                        <button class="btn btn-success btn-sm" style="background:#0891b2;" onclick="SIM.spawnPacket(22)">Test SSH (22)</button>
                        <button class="btn btn-success btn-sm" style="background:#7c3aed;" onclick="SIM.spawnPacket(3389)">Test RDP (3389)</button>
                        <button class="btn btn-danger btn-sm" onclick="SIM.spawnPacket('random')"><i class="fa-solid fa-bug"></i> Random Attack</button>
                    </div>
                </div>
                <div class="log-panel" id="syslog">
                    <div style="border-bottom:1px solid #555; margin-bottom:10px; padding-bottom:5px; color:#e5e7eb; font-weight:bold; letter-spacing:1px; font-size:10px;">KERNEL LOG / TRAFFIC MONITOR</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        //        CONFIGURATION & STATE
        // ==========================================
        const CONFIG = {
            wanIp: '203.0.113.88',
            lanIp: '192.168.0.1', // Changing this will break Port Forwarding
            lanSubnet: '192.168.0', // Derived prefix for validation
            ssid: 'RouterOS_5G',
            guestEnabled: false,
            rules: [], // {id, name, extPort, intIp, intPort, proto, status}
            dhcpList: [
                {name: 'Admin-PC', ip: '192.168.0.100', mac: 'AA:BB:CC:11:22:33'},
                {name: 'Smart-TV', ip: '192.168.0.102', mac: 'AA:BB:CC:44:55:66'},
                {name: 'IoT-Camera', ip: '192.168.0.150', mac: 'AA:BB:CC:77:88:99'}
            ]
        };

        // ==========================================
        //           APPLICATION LOGIC
        // ==========================================
        const APP = {
            uptime: 0,
            showHackerTips: false,

            init() {
                // Load State
                const saved = localStorage.getItem('routerConfigUltimate');
                if(saved) Object.assign(CONFIG, JSON.parse(saved));

                // Recalculate subnet in case it loaded
                this.updateSubnet();

                // Start Uptime
                setInterval(() => {
                    this.uptime++;
                    const h = Math.floor(this.uptime/3600).toString().padStart(2,'0');
                    const m = Math.floor((this.uptime%3600)/60).toString().padStart(2,'0');
                    const s = (this.uptime%60).toString().padStart(2,'0');
                    const el = document.getElementById('uptime');
                    if(el) el.innerText = `${h}:${m}:${s}`;
                }, 1000);

                SIM.init();
            },

            updateSubnet() {
                // Simple logic: assume /24 mask. Take first 3 octets.
                const parts = CONFIG.lanIp.split('.');
                CONFIG.lanSubnet = `${parts[0]}.${parts[1]}.${parts[2]}`;
            },

            login() {
                const u = document.getElementById('user-in').value;
                const p = document.getElementById('pass-in').value;
                if(u === 'admin' && p === 'admin') {
                    document.getElementById('login-overlay').style.display = 'none';
                    document.getElementById('app-container').style.opacity = '1';
                    this.nav('status', document.querySelector('.nav-item'));
                    this.notify('Logged in successfully', 'success');
                } else {
                    this.notify('Invalid Credentials', 'error');
                }
            },

            nav(page, el) {
                // Update Sidebar
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                if(el) el.classList.add('active');
                
                // Update Breadcrumb
                document.getElementById('page-crumb').innerText = `Home > ${page.toUpperCase()}`;
                
                // Render Page
                document.getElementById('main-view').innerHTML = PAGES[page]();
            },

            saveLanSettings() {
                // Handle LAN IP Change
                const newIp = document.getElementById('lan-ip-input').value;
                if(newIp !== CONFIG.lanIp) {
                    if(!confirm("Changing LAN IP requires a system reboot. Port Forwarding rules matching the old subnet will become invalid. Continue?")) return;
                    CONFIG.lanIp = newIp;
                    this.updateSubnet();
                    this.reboot(); // Force reboot on IP change
                } else {
                    this.save();
                }
            },

            save() {
                // Simulate Save Delay
                const btns = document.querySelectorAll('.workspace button');
                btns.forEach(b => {
                    b.disabled = true;
                    if(b.innerText === 'Save') b.innerText = 'Saving...';
                });
                
                setTimeout(() => {
                    localStorage.setItem('routerConfigUltimate', JSON.stringify(CONFIG));
                    btns.forEach(b => {
                        b.disabled = false;
                        if(b.innerText === 'Saving...') b.innerText = 'Save';
                    });
                    this.notify('Settings Saved Successfully', 'success');
                }, 600);
            },

            notify(msg, type) {
                const box = document.getElementById('toast-box');
                const t = document.createElement('div');
                t.className = 'toast';
                t.style.borderLeft = `4px solid ${type==='success'?'var(--success)':'var(--danger)'}`;
                t.innerHTML = `<i class="fa-solid ${type==='success'?'fa-check':'fa-circle-exclamation'}"></i> ${msg}`;
                box.appendChild(t);
                setTimeout(() => { t.remove(); }, 4000);
            },

            reboot() {
                const scr = document.getElementById('reboot-screen');
                const bar = document.getElementById('reboot-bar');
                const txt = document.getElementById('reboot-txt');
                scr.style.display = 'flex';
                
                let p = 0;
                const i = setInterval(() => {
                    p++;
                    bar.style.width = p+'%';
                    txt.innerText = p+'%';
                    if(p>=100) {
                        clearInterval(i);
                        localStorage.setItem('routerConfigUltimate', JSON.stringify(CONFIG));
                        setTimeout(() => location.reload(), 500);
                    }
                }, 30);
            },

            // NAT Logic
            toggleHackerTips() {
                this.showHackerTips = !this.showHackerTips;
                this.nav('nat', null); // Re-render
            },

            addRule() {
                const name = document.getElementById('pf-name').value;
                const ext = document.getElementById('pf-ext').value;
                const ip = document.getElementById('pf-ip').value;
                const int = document.getElementById('pf-int').value || ext;
                const proto = document.getElementById('pf-proto').value;

                if(!name || !ext || !ip) {
                    this.notify('Please fill all required fields', 'error');
                    return;
                }

                CONFIG.rules.push({
                    id: Date.now(),
                    name, extPort: parseInt(ext), intIp: ip, intPort: parseInt(int), proto, status: 'Enabled'
                });
                this.save();
                this.nav('nat', null); // Refresh table
            },

            delRule(id) {
                CONFIG.rules = CONFIG.rules.filter(r => r.id !== id);
                this.save();
                this.nav('nat', null);
            },

            // System Tool
            runPing() {
                const ip = document.getElementById('ping-ip').value;
                const out = document.getElementById('ping-out');
                out.value = `Pinging ${ip} with 32 bytes of data...\n`;
                
                let count = 0;
                const i = setInterval(() => {
                    count++;
                    const ms = Math.floor(Math.random()*15)+1;
                    out.value += `Reply from ${ip}: bytes=32 time=${ms}ms TTL=64\n`;
                    out.scrollTop = out.scrollHeight;
                    SIM.spawnPacket(0, 'ICMP'); // Visual trigger
                    if(count===4) {
                        clearInterval(i);
                        out.value += `\nPing statistics: Sent=4, Received=4, Lost=0.`;
                        out.scrollTop = out.scrollHeight;
                    }
                }, 800);
            }
        };

        // ==========================================
        //             PAGE TEMPLATES
        // ==========================================
        const PAGES = {
            status: () => `
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:25px;">
                    <div class="panel">
                        <div class="panel-head">Device Info</div>
                        <div class="panel-body">
                            <div class="form-grid"><label>Firmware Version:</label> <span>1.0.4 Build 20240901</span></div>
                            <div class="form-grid"><label>Hardware:</label> <span>RouterOS v2.0</span></div>
                            <div class="form-grid"><label>LAN MAC:</label> <span>A8:5E:45:XX:XX:XX</span></div>
                        </div>
                    </div>
                    <div class="panel">
                        <div class="panel-head">System Resources</div>
                        <div class="panel-body">
                            <label style="font-size:12px; font-weight:700; display:block; margin-bottom:5px; color:#555;">CPU Load</label>
                            <div style="background:#e5e7eb; height:8px; border-radius:10px; overflow:hidden; margin-bottom:15px;">
                                <div style="width:${Math.random()*30+5}%; height:100%; background:var(--header-bg);"></div>
                            </div>
                            <label style="font-size:12px; font-weight:700; display:block; margin-bottom:5px; color:#555;">Memory Usage</label>
                            <div style="background:#e5e7eb; height:8px; border-radius:10px; overflow:hidden;">
                                <div style="width:45%; height:100%; background:var(--warning);"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `,

            wan: () => `
                <div class="panel">
                    <div class="panel-head">WAN Connection Type</div>
                    <div class="panel-body">
                        <div class="form-grid">
                            <label>Connection Type</label>
                            <select class="form-control"><option>Dynamic IP (DHCP)</option><option>PPPoE</option><option>Static IP</option></select>
                        </div>
                        <div class="form-grid">
                            <label>IP Address</label>
                            <input type="text" class="form-control" value="${CONFIG.wanIp}" readonly style="background:#f3f4f6; color:#6b7280;">
                        </div>
                        <div class="form-grid">
                            <label>Subnet Mask</label>
                            <input type="text" class="form-control" value="255.255.255.248" readonly style="background:#f3f4f6; color:#6b7280;">
                        </div>
                        <div class="form-grid">
                            <label>Default Gateway</label>
                            <input type="text" class="form-control" value="203.0.113.1" readonly style="background:#f3f4f6; color:#6b7280;">
                        </div>
                        <div class="form-grid">
                            <label></label>
                            <div style="display:flex; gap:10px;">
                                <button class="btn btn-sm" onclick="APP.save()">Save Settings</button>
                                <button class="btn btn-outline btn-sm">Renew IP</button>
                            </div>
                        </div>
                    </div>
                </div>
            `,

            lan: () => `
                <div class="panel">
                    <div class="panel-head">LAN Interface Settings</div>
                    <div class="panel-body">
                        <div class="hacker-tip-box visible" style="border-color:#f59e0b; background:#fffbeb; color:#92400e;">
                            <strong><i class="fa-solid fa-triangle-exclamation"></i> Impact Warning:</strong><br>
                            Changing the IP Address will change your network subnet. Any Port Forwarding rules pointing to the old subnet will become <strong>Invalid</strong> and traffic will fail.
                        </div>
                        <div class="form-grid">
                            <label>MAC Address</label>
                            <span style="font-family:monospace;">A8:5E:45:11:22:33</span>
                        </div>
                        <div class="form-grid">
                            <label>IP Address</label>
                            <input type="text" id="lan-ip-input" class="form-control" value="${CONFIG.lanIp}">
                        </div>
                        <div class="form-grid">
                            <label>Subnet Mask</label>
                            <select class="form-control"><option>255.255.255.0</option><option>255.255.0.0</option></select>
                        </div>
                        <button class="btn" onclick="APP.saveLanSettings()">Save & Reboot</button>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-head">DHCP Client List</div>
                    <div class="panel-body">
                        <table>
                            <thead><tr><th>ID</th><th>Client Name</th><th>MAC Address</th><th>Assigned IP</th><th>Lease Time</th></tr></thead>
                            <tbody>
                                ${CONFIG.dhcpList.map((c,i) => `
                                    <tr>
                                        <td>${i+1}</td>
                                        <td><strong>${c.name}</strong></td>
                                        <td style="font-family:monospace;">${c.mac}</td>
                                        <td>${c.ip.replace('192.168.0', CONFIG.lanSubnet)}</td> <td>2 hours</td>
                                    </tr>`).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `,

            wireless: () => `
                <div class="panel">
                    <div class="panel-head">Wireless 2.4GHz / 5GHz</div>
                    <div class="panel-body">
                        <div class="form-grid">
                            <label>Network Name (SSID)</label>
                            <input type="text" class="form-control" value="${CONFIG.ssid}">
                        </div>
                        <div class="form-grid">
                            <label>Security</label>
                            <select class="form-control"><option>WPA2/WPA3 Personal</option></select>
                        </div>
                        <div class="form-grid">
                            <label>Password</label>
                            <input type="password" class="form-control" value="secret1234">
                        </div>
                        <button class="btn btn-sm" onclick="APP.save()">Save</button>
                    </div>
                </div>
            `,

            nat: () => `
                <div class="panel">
                    <div class="panel-head">
                        <div>Virtual Servers (Port Forwarding)</div>
                        <button class="btn btn-outline btn-sm" onclick="APP.toggleHackerTips()">
                            <i class="fa-solid fa-user-secret"></i> ${APP.showHackerTips ? 'Hide Risks' : 'Show Risks'}
                        </button>
                    </div>
                    <div class="panel-body">
                        
                        <div class="hacker-tip-box ${APP.showHackerTips ? 'visible' : ''}">
                            <strong><i class="fa-solid fa-triangle-exclamation"></i> Security Warning:</strong><br>
                            Forwarding ports creates a direct hole in your firewall. 
                            <ul>
                                <li><strong>Port 80 (HTTP):</strong> Exposes web panels. Bots scan this continuously.</li>
                                <li><strong>Port 22 (SSH):</strong> High risk. Attackers brute-force passwords here.</li>
                                <li><strong>Port 3389 (RDP):</strong> Critical risk. Often used for ransomware entry.</li>
                            </ul>
                        </div>

                        <div style="background:#f9fafb; padding:20px; border-radius:6px; border:1px solid #e5e7eb; margin-bottom:25px;">
                            <div style="font-weight:700; margin-bottom:15px; color:#4b5563;">Create New Rule</div>
                            <div style="display:flex; flex-wrap:wrap; gap:12px; align-items:end;">
                                <div style="flex:1; min-width:120px;"><div style="font-size:11px; margin-bottom:4px; font-weight:600;">Service Name</div><input type="text" id="pf-name" class="form-control" placeholder="e.g. Web Server"></div>
                                <div style="width:80px;"><div style="font-size:11px; margin-bottom:4px; font-weight:600;">Ext Port</div><input type="number" id="pf-ext" class="form-control" placeholder="80"></div>
                                <div style="flex:1; min-width:120px;"><div style="font-size:11px; margin-bottom:4px; font-weight:600;">Internal IP</div><input type="text" id="pf-ip" class="form-control" value="${CONFIG.lanSubnet}.100"></div>
                                <div style="width:80px;"><div style="font-size:11px; margin-bottom:4px; font-weight:600;">Int Port</div><input type="number" id="pf-int" class="form-control" placeholder="80"></div>
                                <div style="width:90px;"><div style="font-size:11px; margin-bottom:4px; font-weight:600;">Protocol</div><select id="pf-proto" class="form-control"><option>TCP</option><option>UDP</option><option>ALL</option></select></div>
                                <button class="btn" style="height:42px;" onclick="APP.addRule()">+ Add</button>
                            </div>
                        </div>

                        <table>
                            <thead>
                                <tr><th>Service Name</th><th>External Port</th><th>Internal IP</th><th>Internal Port</th><th>Proto</th><th>Status</th><th>Action</th></tr>
                            </thead>
                            <tbody>
                                ${CONFIG.rules.length === 0 ? '<tr><td colspan="7" style="text-align:center; color:#999; padding:20px;">No Forwarding Rules Configured</td></tr>' : ''}
                                ${CONFIG.rules.map(r => {
                                    // CHECK VALIDITY
                                    const isValid = r.intIp.startsWith(CONFIG.lanSubnet);
                                    return `
                                    <tr style="${isValid ? '' : 'background:#fef2f2;'}">
                                        <td>${r.name}</td>
                                        <td style="font-weight:700;">${r.extPort}</td>
                                        <td style="${isValid ? '' : 'color:red; font-weight:bold;'}">${r.intIp} ${isValid ? '' : '<i class="fa-solid fa-circle-exclamation" title="Subnet Mismatch"></i>'}</td>
                                        <td>${r.intPort}</td>
                                        <td>${r.proto}</td>
                                        <td>
                                            ${isValid 
                                                ? '<span class="badge badge-success">Enabled</span>' 
                                                : '<span class="badge badge-danger">Subnet Error</span>'}
                                        </td>
                                        <td><button style="color:#ef4444; background:none; border:none; cursor:pointer;" onclick="APP.delRule(${r.id})"><i class="fa-solid fa-trash"></i></button></td>
                                    </tr>
                                `}).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `,

            security: () => `
                <div class="panel">
                    <div class="panel-head">Firewall Configuration</div>
                    <div class="panel-body">
                        <div class="form-grid">
                            <label>SPI Firewall</label>
                            <label style="color:var(--success); font-weight:700;"><i class="fa-solid fa-check-circle"></i> Enabled</label>
                        </div>
                        <div class="form-grid">
                            <label>DoS Protection</label>
                            <select class="form-control"><option>Enabled (High)</option><option>Enabled (Low)</option><option>Disabled</option></select>
                        </div>
                        <div class="form-grid">
                            <label>Ping from WAN</label>
                            <label><input type="checkbox" checked> Forbid Ping Packet from WAN Port</label>
                        </div>
                        <button class="btn btn-sm" onclick="APP.save()">Save Settings</button>
                    </div>
                </div>
            `,

            system: () => `
                <div class="panel">
                    <div class="panel-head">Diagnostic Tools</div>
                    <div class="panel-body">
                        <div class="form-grid">
                            <label>Tool Type</label>
                            <select class="form-control"><option>Ping</option><option>Traceroute</option></select>
                        </div>
                        <div class="form-grid">
                            <label>IP Address/Domain</label>
                            <input type="text" class="form-control" id="ping-ip" value="8.8.8.8">
                        </div>
                        <button class="btn btn-sm" onclick="APP.runPing()">Start Diagnosis</button>
                        <textarea id="ping-out" style="width:100%; height:140px; margin-top:15px; background:#1f2937; color:#10b981; border-radius:6px; padding:12px; font-family:monospace; box-sizing:border-box;" readonly></textarea>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-head" style="color:var(--danger);">System Maintenance</div>
                    <div class="panel-body">
                        <div style="display:flex; gap:15px;">
                            <button class="btn btn-danger btn-sm" onclick="APP.reboot()"><i class="fa-solid fa-power-off"></i> Reboot Router</button>
                            <button class="btn btn-outline btn-sm" onclick="if(confirm('Reset all settings?')) { localStorage.removeItem('routerConfigUltimate'); location.reload(); }"><i class="fa-solid fa-rotate-left"></i> Factory Reset</button>
                        </div>
                    </div>
                </div>
            `
        };

        // ==========================================
        //         VISUALIZER (CANVAS ENGINE)
        // ==========================================
        const SIM = {
            canvas: null, ctx: null, packets: [], width: 0, height: 0,

            init() {
                this.canvas = document.getElementById('net-canvas');
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                window.addEventListener('resize', () => this.resize());
                this.loop();
            },

            resize() {
                this.width = this.canvas.width = this.canvas.parentElement.offsetWidth;
                this.height = this.canvas.height = this.canvas.parentElement.offsetHeight;
            },

            log(msg, type) {
                const p = document.getElementById('syslog');
                const div = document.createElement('div');
                div.className = 'log-line ' + (type === 'allow' ? 'log-allow' : type === 'block' ? 'log-block' : type === 'warn' ? 'log-warn' : 'log-info');
                div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
                p.prepend(div);
                if(p.children.length > 30) p.lastChild.remove();
            },

            spawnPacket(port, type='TCP') {
                let p = port === 'random' ? Math.floor(Math.random()*2000)+1000 : port;
                this.packets.push({
                    x: 50, y: this.height/2, speed: 3 + Math.random(), 
                    port: p, status: 'traveling', type: (type==='ICMP'?'ICMP':'TCP')
                });
            },

            loop() {
                const ctx = this.ctx;
                const cx = this.width / 2;
                const cy = this.height / 2;

                ctx.fillStyle = '#111827';
                ctx.fillRect(0,0,this.width, this.height);

                // DRAW NETWORK
                ctx.strokeStyle = '#374151'; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.moveTo(80, cy); ctx.lineTo(cx-40, cy); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(cx+40, cy); ctx.lineTo(this.width-80, cy); ctx.stroke();

                // DEVICES
                ctx.textAlign = "center"; ctx.font = "24px FontAwesome";
                ctx.fillStyle = "#9ca3af"; ctx.fillText("\uf0c2", 50, cy+10); // Cloud
                ctx.fillStyle = "#0f4c81"; ctx.fillText("\uf233", cx, cy+10); // Router
                ctx.fillStyle = "#9ca3af"; ctx.fillText("\uf108", this.width-50, cy+10); // PC
                
                // PACKET LOGIC
                for(let i = this.packets.length - 1; i >= 0; i--) {
                    let p = this.packets[i];

                    if(p.status === 'traveling') {
                        if(p.x < cx - 40) {
                            p.x += p.speed;
                        } else {
                            // HIT ROUTER
                            if(p.type === 'ICMP') {
                                p.status = 'forwarded';
                                this.log(`ICMP Echo Request -> ${CONFIG.wanIp}`, 'info');
                            } else {
                                const match = CONFIG.rules.find(r => r.extPort == p.port);
                                if(match) {
                                    // NEW: Check Subnet Validity
                                    if(match.intIp.startsWith(CONFIG.lanSubnet)) {
                                        p.status = 'forwarded';
                                        this.log(`WAN:${p.port} MATCHED Rule: ${match.name} -> LAN:${match.intIp}`, 'allow');
                                    } else {
                                        p.status = 'blocked';
                                        this.log(`ROUTING ERROR: WAN:${p.port} matched ${match.name} but Destination ${match.intIp} is Unreachable (Subnet Mismatch)`, 'warn');
                                    }
                                } else {
                                    p.status = 'blocked';
                                    this.log(`WAN:${p.port} DROPPED (Default Policy: Deny)`, 'block');
                                }
                            }
                        }
                    } else if (p.status === 'forwarded') {
                        if(p.x < this.width - 80) p.x += p.speed;
                        else this.packets.splice(i, 1);
                    } else if (p.status === 'blocked') {
                        p.y += 2;
                        if(p.y > this.height) this.packets.splice(i, 1);
                    }

                    // DRAW PACKET
                    ctx.fillStyle = p.status === 'blocked' ? '#ef4444' : p.status === 'forwarded' ? '#10b981' : '#fff';
                    ctx.beginPath(); ctx.arc(p.x, p.y, 5, 0, Math.PI*2); ctx.fill();
                    ctx.font = "10px monospace"; ctx.fillText(p.type==='ICMP'?'PING':p.port, p.x, p.y-10);
                }

                requestAnimationFrame(() => this.loop());
            }
        };

        // Boot
        APP.init();

    </script>
</body>
</html>
